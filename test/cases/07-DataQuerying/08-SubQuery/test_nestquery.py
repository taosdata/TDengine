from new_test_framework.utils import tdLog, tdSql, sc, clusterComCheck


class TestNestquery:

    def setup_class(cls):
        tdLog.debug(f"start to execute {__file__}")

    def test_nestquery(self):
        """nest query

        1.

        Catalog:
            - DataTypes

        Since: v3.0.0.0

        Labels: common,ci

        Jira: None

        History:
            - 2025-5-8 Simon Guan Migrated from tsim/parser/nestquery.sim

        """

        tdLog.info(f"======================== dnode1 start")

        dbPrefix = "nest_db"
        tbPrefix = "nest_tb"
        mtPrefix = "nest_mt"
        tbNum = 3
        rowNum = 10000
        totalNum = tbNum * rowNum

        tdLog.info(f"=============== nestquery.sim")
        i = 0
        db = dbPrefix + str(i)
        mt = mtPrefix + str(i)

        tdSql.execute(f"drop database if exists {db}")
        tdSql.execute(f"create database if not exists {db}")

        tdSql.execute(f"use {db}")
        tdSql.execute(
            f"create table {mt} (ts timestamp, c1 int, c2 float, c3 bigint, c4 smallint, c5 tinyint, c6 double, c7 bool, c8 binary(10), c9 nchar(9)) TAGS(t1 int)"
        )

        half = 2

        i = 0
        while i < half:
            tb = tbPrefix + str(i)

            nextSuffix = i + half
            tb1 = tbPrefix + str(nextSuffix)

            tdSql.execute(f"create table {tb} using {mt} tags( {i} )")
            tdSql.execute(f"create table {tb1} using {mt} tags( {nextSuffix} )")

            x = 0
            while x < rowNum:
                y = x * 60000
                ms = 1600099200000 + y
                c = x % 100
                binary = "'binary" + str(c) + "'"
                nchar = "'nchar" + str(c) + "'"
                tdSql.execute(
                    f"insert into {tb} values ({ms} , {c} , {c} , {c} , {c} , {c} , {c} , {c} , {binary} , {nchar} )  {tb1} values ({ms} , {c} , {c} , {c} , {c} , {c} , {c} , {c} , {binary} , {nchar} )"
                )
                x = x + 1

            i = i + 1

        i = 1
        tb = tbPrefix + str(i)

        tdLog.info(f"==============> simple nest query test")
        tdSql.query(f"select count(*) from (select count(*) from nest_mt0)")
        tdSql.checkRows(1)

        tdSql.checkData(0, 0, 1)

        tdSql.query(
            f"select count(*) from (select count(*) from nest_mt0 group by tbname)"
        )
        tdSql.checkRows(1)

        tdSql.checkData(0, 0, 4)

        tdSql.query(
            f"select count(*) from (select count(*) from nest_mt0 partition by tbname interval(10h) )"
        )
        tdSql.checkRows(1)

        tdSql.checkData(0, 0, 68)

        tdSql.query(
            f"select sum(a) from (select count(*) a from nest_mt0 partition by tbname interval(10h))"
        )
        tdSql.checkRows(1)

        tdSql.checkData(0, 0, 40000)

        tdLog.info(f"=================> alias name test")
        tdSql.query(
            f"select ts from (select _wstart as ts, count(*) a from nest_tb0 interval(1h))"
        )
        tdSql.checkRows(167)

        tdSql.checkData(0, 0, "2020-09-15 00:00:00")

        tdSql.query(
            f"select count(a) from (select count(*) a from nest_tb0 interval(1h))"
        )
        tdSql.checkRows(1)

        tdSql.checkData(0, 0, 167)

        tdLog.info(f"================>master query + filter")
        tdSql.query(
            f"select t.* from (select count(*) a from nest_tb0 interval(10h)) t where t.a <= 520;"
        )
        tdSql.checkRows(2)

        tdSql.query(
            f"select * from (select count(*) a, tbname f1 from nest_mt0 group by tbname) t where t.a<0 and f1 = 'nest_tb0';"
        )
        tdSql.checkRows(0)

        tdSql.query(
            f"select * from (select count(*) a, tbname f1, tbname from nest_mt0 group by tbname) t where t.a>0 and f1 = 'nest_tb0';"
        )
        tdSql.checkRows(1)

        tdSql.checkData(0, 0, 10000)

        tdSql.checkData(0, 1, "nest_tb0")

        tdSql.checkData(0, 2, "nest_tb0")

        tdLog.info(f"===================> nest query interval")
        tdSql.error(f"select ts, avg(c1) from (select ts, c1 from nest_tb0);")

        tdSql.query(
            f"select _wstart, avg(c1) from (select * from nest_tb0) interval(3d)"
        )
        tdLog.info(
            f"{tdSql.getData(0,0)} {tdSql.getData(0,1)} {tdSql.getData(1,0)} {tdSql.getData(1,1)} {tdSql.getData(2,0)} {tdSql.getData(2,1)}"
        )
        tdSql.checkRows(3)

        tdSql.checkData(0, 0, "2020-09-14 00:00:00")

        tdSql.checkData(0, 1, 49.222222222)

        tdSql.checkData(1, 0, "2020-09-17 00:00:00")

        tdSql.checkData(1, 1, 49.685185185)

        tdSql.checkData(2, 0, "2020-09-20 00:00:00")

        tdSql.checkData(2, 1, 49.500000000)

        tdSql.query(f"select stddev(c1) from (select c1 from nest_tb0);")
        tdSql.error(f"select percentile(c1, 20) from (select * from nest_tb0);")
        # sql select interp(c1) from (select * from nest_tb0);
        tdSql.error(
            f"select derivative(val, 1s, 0) from (select c1 val from nest_tb0);"
        )
        tdSql.error(f"select twa(c1) from (select c1 from nest_tb0);")
        tdSql.error(f"select irate(c1) from (select c1 from nest_tb0);")
        tdSql.error(f"select diff(c1), twa(c1) from (select * from nest_tb0);")
        # sql_error select irate(c1), interp(c1), twa(c1) from (select * from nest_tb0);

        tdSql.query(
            f"select _wstart, apercentile(c1, 50) from (select * from nest_tb0) interval(1d)"
        )
        tdSql.checkRows(7)

        tdSql.checkData(0, 0, "2020-09-15 00:00:00")

        tdSql.checkData(0, 1, 47.571428571)

        tdSql.checkData(1, 0, "2020-09-16 00:00:00")

        tdSql.checkData(1, 1, 49.666666667)

        tdSql.checkData(2, 0, "2020-09-17 00:00:00")

        tdSql.checkData(2, 1, 49.000000000)

        tdSql.checkData(3, 0, "2020-09-18 00:00:00")

        tdSql.checkData(3, 1, 48.333333333)

        tdSql.query(f"select twa(c1) from (select * from nest_tb0);")
        tdSql.checkRows(1)

        tdSql.checkData(0, 0, 49.500000000)

        tdSql.query(f"select leastsquares(c1, 1, 1) from (select * from nest_tb0);")
        tdSql.checkRows(1)

        tdSql.checkData(0, 0, "{slop:0.000100, intercept:49.000000}")

        tdSql.query(f"select irate(c1) from (select * from nest_tb0);")
        tdSql.checkData(0, 0, 0.016666667)

        tdSql.query(f"select derivative(c1, 1s, 0) from (select * from nest_tb0);")
        tdLog.info(f"{tdSql.getRows()}) {tdSql.getData(0,0)} {tdSql.getData(1,0)}")
        tdSql.checkRows(9999)

        tdSql.checkData(0, 0, 0.016666667)

        tdSql.checkData(1, 0, 0.016666667)

        tdSql.query(f"select diff(c1) from (select * from nest_tb0);")
        tdSql.checkRows(9999)

        tdSql.query(
            f"select _wstart, avg(c1),sum(c2), max(c3), min(c4), count(*), first(c7), last(c7),spread(c6) from (select * from nest_tb0) interval(1d);"
        )
        tdSql.checkRows(7)

        tdSql.checkData(0, 0, "2020-09-15 00:00:00")

        tdSql.checkData(0, 1, 48.666666667)

        tdSql.checkData(0, 2, 70080.000000000)

        tdSql.checkData(0, 3, 99)

        tdSql.checkData(0, 4, 0)

        tdSql.checkData(0, 5, 1440)

        tdSql.checkData(0, 6, 0)

        tdSql.checkData(0, 7, 1)

        tdSql.checkData(0, 8, 99.000000000)

        tdSql.checkData(1, 0, "2020-09-16 00:00:00")

        tdSql.checkData(1, 1, 49.777777778)

        tdSql.checkData(1, 2, 71680.000000000)

        tdSql.query(f"select top(x, 20) from (select c1 x from nest_tb0);")

        tdSql.query(f"select bottom(x, 20) from (select c1 x from nest_tb0)")

        tdLog.info(f"===================> group by + having")

        tdLog.info(f"=========================> ascending order/descending order")

        tdLog.info(f"=========================> nest query join")
        tdSql.query(
            f"select a.ts,a.k,b.ts from (select _wstart ts, count(*) k from nest_tb0 interval(30a)) a, (select _wstart ts, count(*) f from nest_tb1 interval(30a)) b where a.ts = b.ts ;"
        )
        tdSql.checkRows(10000)

        tdSql.checkData(0, 0, "2020-09-15 00:00:00")

        tdSql.checkData(0, 1, 1)

        tdSql.checkData(0, 2, "2020-09-15 00:00:00")

        tdSql.checkData(1, 0, "2020-09-15 00:01:00")

        tdSql.checkData(1, 1, 1)

        tdSql.checkData(1, 2, "2020-09-15 00:01:00")

        tdSql.query(
            f"select sum(a.k), sum(b.f) from (select _wstart ts, count(*) k from nest_tb0 interval(30a)) a, (select _wstart ts, count(*) f from nest_tb1 interval(30a)) b where a.ts = b.ts ;"
        )
        tdSql.checkRows(1)

        tdSql.checkData(0, 0, 10000)

        tdSql.checkData(0, 1, 10000)

        tdSql.query(
            f"select a.ts,a.k,b.ts,c.ts,c.ts,c.x from (select _wstart ts, count(*) k from nest_tb0 interval(30a)) a, (select _wstart ts, count(*) f from nest_tb1 interval(30a)) b, (select _wstart ts, count(*) x from nest_tb2 interval(30a)) c where a.ts = b.ts and a.ts = c.ts"
        )
        tdSql.checkRows(10000)

        tdSql.checkData(0, 0, "2020-09-15 00:00:00")

        tdSql.checkData(0, 1, 1)

        tdSql.checkData(0, 2, "2020-09-15 00:00:00")

        tdSql.checkData(0, 3, "2020-09-15 00:00:00")

        # sql select diff(val) from (select c1 val from nest_tb0);
        # if $rows != 9999 then
        #  return -1
        # endi
        # if $tdSql.getData(0,0, 1 then
        #  return -1
        # endi

        tdSql.error(f"select last_row(*) from (select * from nest_tb0) having c1 > 0")

        tdLog.info(f"===========>td-4805")
        tdSql.error(f"select tbname, i from (select * from nest_tb0) group by i;")

        tdSql.query(
            f"select count(*),c1 from (select * from nest_tb0) where c1 < 2 group by c1 order by c1;"
        )
        tdSql.checkRows(2)

        tdSql.checkData(0, 0, 100)

        tdSql.checkData(0, 1, 0)

        tdSql.checkData(1, 0, 100)

        tdSql.checkData(1, 1, 1)

        tdLog.info(f"=====================>TD-5157")
        tdSql.query(f"select _wstart, twa(c1) from nest_tb1 interval(19a);")
        tdSql.checkRows(10000)

        tdSql.checkData(0, 0, "2020-09-14 23:59:59.992")

        tdSql.checkData(0, 1, 0.000083333)

        tdLog.info(f"======================>TD-5271")
        tdSql.error(
            f"select min(val),max(val),first(val),last(val),count(val),sum(val),avg(val) from (select count(*) val from nest_mt0 group by tbname)"
        )

        tdLog.info(f"=================>us database interval query, TD-5039")
        tdSql.execute(f"create database test precision 'us';")
        tdSql.execute(f"use test;")
        tdSql.execute(f"create table t1(ts timestamp, k int);")
        tdSql.execute(
            f"insert into t1 values('2020-01-01 01:01:01.000', 1) ('2020-01-01 01:02:00.000', 2);"
        )
        tdSql.query(
            f"select _wstart, avg(k) from (select _wstart, avg(k) k from t1 interval(1s)) interval(1m);"
        )
        tdSql.checkRows(2)

        tdSql.checkData(0, 0, "2020-01-01 01:01:00")

        tdSql.checkData(0, 1, 1.000000000)

        tdSql.checkData(1, 0, "2020-01-01 01:02:00")

        tdSql.checkData(1, 1, 2.000000000)
