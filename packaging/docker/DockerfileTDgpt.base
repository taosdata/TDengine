FROM python:3.10-slim AS base-builder

RUN apt-get -o Acquire::Check-Valid-Until=false -o Acquire::Check-Date=false update -y && \
    apt-get install -y --no-install-recommends gcc libc-dev procps && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN pip3 install --upgrade pip && \
    pip3 install --no-cache-dir --ignore-installed blinker && \
    pip3 install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu && \
    pip3 install --no-cache-dir \
                    numpy==1.26.4 \
                    pandas==1.5.0 \
                    scikit-learn \
                    outlier_utils \
                    statsmodels \
                    pyculiarity \
                    pmdarima \
                    flask \
                    matplotlib \
                    taospy \
                    uwsgi \
                    accelerate \
                    tensorflow \
                    uni2ts \
                    -i https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip install --upgrade keras -i https://pypi.tuna.tsinghua.edu.cn/simple && \
    find $VIRTUAL_ENV -type d -name '__pycache__' -exec rm -rf {} + && \
    find $VIRTUAL_ENV -type d -name 'tests' -exec rm -rf {} +

FROM python:3.10-slim AS venv1-builder
COPY --from=base-builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=base-builder /usr/local/bin /usr/local/bin
ENV VIRTUAL_ENV=/var/lib/taos/taosanode/venv1
ENV PATH="$VIRTUAL_ENV/bin:$PATH"
RUN python3.10 -m venv --system-site-packages /var/lib/taos/taosanode/venv1 && \
    pip install --no-cache-dir transformers==4.40 && \
    find $VIRTUAL_ENV -type d -name '__pycache__' -exec rm -rf {} + && \
    find $VIRTUAL_ENV -type d -name 'tests' -exec rm -rf {} +

FROM python:3.10-slim AS venv2-builder
COPY --from=base-builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=base-builder /usr/local/bin /usr/local/bin
ENV VIRTUAL_ENV=/var/lib/taos/taosanode/venv2
ENV PATH="$VIRTUAL_ENV/bin:$PATH"
RUN python -m venv --system-site-packages /var/lib/taos/taosanode/venv2 && \
    pip install --no-cache-dir transformers==4.55 && \
    find $VIRTUAL_ENV -type d -name '__pycache__' -exec rm -rf {} + && \
    find $VIRTUAL_ENV -type d -name 'tests' -exec rm -rf {} +

FROM python:3.10-slim AS venv3-builder
COPY --from=base-builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=base-builder /usr/local/bin /usr/local/bin
ENV VIRTUAL_ENV=/var/lib/taos/taosanode/venv3
ENV PATH="$VIRTUAL_ENV/bin:$PATH"
RUN python -m venv --system-site-packages /var/lib/taos/taosanode/venv3 && \
    pip install --no-cache-dir transformers==4.33 && \
    find $VIRTUAL_ENV -type d -name '__pycache__' -exec rm -rf {} + && \
    find $VIRTUAL_ENV -type d -name 'tests' -exec rm -rf {} +

FROM python:3.10-slim
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends procps && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
COPY --from=base-builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=base-builder /usr/local/bin /usr/local/bin
RUN python -m venv --system-site-packages /var/lib/taos/taosanode/venv
COPY --from=venv1-builder /var/lib/taos/taosanode/venv1 /var/lib/taos/taosanode/venv1
COPY --from=venv2-builder /var/lib/taos/taosanode/venv2 /var/lib/taos/taosanode/venv2
COPY --from=venv3-builder /var/lib/taos/taosanode/venv3 /var/lib/taos/taosanode/venv3
