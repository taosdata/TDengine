---
sidebar_label: MQTT
title: “MQTT”数据源
description: 使用“MQTT”数据源导入数据到 TDengine Cloud 的实例
---

MQTT 数据写入，是通过连接代理把数据从 MQTT 服务器写入到当前选择的 TDengine Cloud 实例。

## 先决条件

- 创建一个空数据库来存储 MQTT 数据。更多信息，请参阅 [数据库](../../../programming/model/#create-database)。
- 确保连接代理运行在与 MQTT 服务器位于同一网络的机器上。更多信息，请参阅 [安装连接代理](../install-agent/)。

## 具体步骤

1. 在 TDengine Cloud 中，在左边菜单中打开 **数据写入** 页面，在 **数据源** 选项卡上，单击 **添加数据源**打开新增页面。在**名称**输入框里面填写这个数据源的名称，并选择 **MQTT** 类型，在**代理**选择框里面选择已经创建的代理，如果没有创建代理，请点击旁边的**创建新的代理**按钮去创建新代理。
2. 在**目标数据库**里面选择一个当前所在的 TDengine Cloud 实例里面的数据库作为目标数据库。
3. 在 **MQTT 地址**卡片，输入 MQTT 地址，必填字段，包括 IP 和 端口号，例如：192.168.1.10:1883;
4. 可以点击**连通性检查**, 检查 Cloud 实例 与 MQTT 服务之间是否可以连通。
5. 在 **SSL 证书**卡片，可以选择是否打开 SSL/TLS 开关，如果打开此开关，MQTT 连接器和 MQTT 服务器之间的通信将采用 SSL/TLS 的方式进行加密；打开这个开关后，会出现 CA, 客户端证书和客户端私钥三个必填配置项，可以在这里输入证书和私钥文件的内容；
6. 在**连接**卡片，可以配置以下信息：
   - MQTT 协议：支持 3.1/3.1.1/5.0 三个版本；
   - Client ID: MQTT 连接器连接 MQTT 服务器时所使用的客户端 ID, 用于标识客户端的身份；
   - Keep Alive: 用于配置 MQTT 连接器与 MQTT 服务器之间的 Keep Alive 时间，默认值为 60 秒；
   - Clean Session: 用于配置 MQTT 连接器是否以 Clean Session 的方式连接至 MQTT 服务器，默认值为 True;
   - 订阅主题及 QoS 配置：这里用来配置监听的 MQTT 主题，以及该主题支持的最大 QoS, 主题和 QoS 的配置之间用::分隔，多个主题之间用,分隔，主题的配置可以支持 MQTT 协议的通配符#和+;
7. 在**其他**卡片，可以配置 MQTT 连接器的日志级别，支持 error, warn, info, debug, trace 5 个级别，默认值为 info;
8. 在**MQTT Payload 解析**卡片，用于配置如何解析 MQTT 消息：
   - 配置表的第一行为 ts 字段，该字段为 TIMESTAMP 类型，它的值为 MQTT 连接器收到 MQTT 消息的时间；
   - 配置表的第二行为 topic 字段，为该消息的主题名称，可以选择将该字段作为列或者标签同步至 TDengine;
   - 配置表的第三行为 qos 字段，为该消息的 QoS 属性，可以选择将该字段作为列或者标签同步至 TDengine;
   - 剩余的配置项皆为自定义字段，每个字段都需要配置：字段（来源），列（目标），列类型（目标）。字段（来源）是指该 MQTT 消息中的字段名称，当前仅支持 JSON 类型的 MQTT 消息同步，可以使用 JSON Path 语法从 MQTT 消息中提取字段，例如：$.data.id; 列（目标）是指同步至 TDengine 后的字段名称；列类型（目标）是指同步至 TDengine 后的字段类型，可以从下拉列表中选择；当且仅当以上 3 个配置都填写后，才能新增下一个字段；
   - 如果 MQTT 消息中包含时间戳，可以选择新增一个自定义字段，将其作为同步至 TDengine 时的主键；需要注意的是，MQTT 消息中时间戳的仅支持 Unix Timestamp 格式，且该字段的列类型（目标）的选择，需要与创建 TDengine 数据库时的配置一致；
   - 子表命名规则：用于配置子表名称，采用“前缀+{列类型(目标)}”的格式，例如：d{id};
   - 超级表名：用于配置同步至 TDengine 时，采用的超级表名；
9. 在**认证**卡片，输入 MQTT 连接器访问 MQTT 服务器时的用户名和密码，这两个字段为选填字段，如果未输入，即采用匿名认证的方式；
10. 填写完成以上信息后，点击**新增**按钮，即可直接启动从 MQTT 到 TDengine 的数据同步。
